<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conflicto Armado Colombia - Data Storytelling</title>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #8B0000;
            --secondary: #DC143C;
            --accent: #FFD700;
            --dark-bg: #0A0E27;
            --light-text: #E8E8E8;
            --card-bg: #16213E;
            --border: #1F3A5F;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0A0E27 0%, #1a1f3a 100%);
            color: var(--light-text);
        }
        header {
            background: linear-gradient(180deg, rgba(139, 0, 0, 0.95) 0%, rgba(220, 20, 60, 0.95) 100%);
            padding: 3rem 2rem;
            border-bottom: 3px solid var(--accent);
            position: relative;
            overflow: hidden;
        }
        header h1 {
            font-family: 'Syne', sans-serif;
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        .container { max-width: 1600px; margin: 0 auto; padding: 2rem; }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin: 3rem 0;
        }
        .metric-card {
            background: linear-gradient(135deg, var(--card-bg) 0%, #1F3A5F 100%);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            transition: all 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-8px);
            border-color: var(--secondary);
            box-shadow: 0 20px 40px rgba(139, 0, 0, 0.3);
        }
        .metric-value {
            font-family: 'Syne', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent);
            margin: 1rem 0;
        }
        .section { margin: 4rem 0; }
        .section-title {
            font-family: 'Syne', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 1rem;
        }
        .chart-container {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        .chart-wrapper {
            position: relative;
            height: 450px;
            width: 100%;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
        }
        #mapa { width: 100%; height: 700px; border-radius: 12px; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: rgba(139, 0, 0, 0.3); }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border); }
        tbody tr:hover { background: rgba(220, 20, 60, 0.1); }
        footer {
            background: var(--dark-bg);
            border-top: 1px solid var(--border);
            padding: 2rem;
            text-align: center;
            margin-top: 4rem;
        }
        @media (max-width: 768px) {
            header h1 { font-size: 2rem; }
            .charts-grid { grid-template-columns: 1fr; }
            #mapa { height: 400px; }
        }
    </style>
</head>
<body>
    <header>
        <h1>馃嚚馃嚧 Conflicto Armado en Colombia</h1>
        <p>An谩lisis Interactivo - Data Storytelling Maestr铆a UNAD</p>
    </header>

    <div class="container">
        <section class="metrics-grid" id="metricas">
            <div class="metric-card">
                <div style="opacity: 0.7;">Total de Afectados</div>
                <div class="metric-value" id="metric-afectados">Cargando...</div>
            </div>
            <div class="metric-card">
                <div style="opacity: 0.7;">Total de Eventos</div>
                <div class="metric-value" id="metric-eventos">Cargando...</div>
            </div>
            <div class="metric-card">
                <div style="opacity: 0.7;">Asesinados</div>
                <div class="metric-value" id="metric-asesinados">Cargando...</div>
            </div>
            <div class="metric-card">
                <div style="opacity: 0.7;">Heridos</div>
                <div class="metric-value" id="metric-heridos">Cargando...</div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">馃搱 An谩lisis Temporal y Distribuci贸n</h2>
            <div class="charts-grid">
                <div class="chart-container">
                    <h3 style="color: var(--accent); margin-bottom: 1rem;">Evoluci贸n Anual (2010-2024)</h3>
                    <div class="chart-wrapper"><canvas id="g1"></canvas></div>
                </div>
                <div class="chart-container">
                    <h3 style="color: var(--accent); margin-bottom: 1rem;">Heridos vs Asesinados</h3>
                    <div class="chart-wrapper" style="height: 350px;"><canvas id="g2"></canvas></div>
                </div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">馃敶 Top 15 Departamentos</h2>
            <div class="chart-container">
                <div class="chart-wrapper" style="height: 550px;"><canvas id="g3"></canvas></div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">猸?Intensidad por Regi贸n (Radar)</h2>
            <div class="chart-container">
                <div class="chart-wrapper" style="height: 500px;"><canvas id="g4"></canvas></div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">馃椇锔?Mapa de Calor Geogr谩fico</h2>
            <div class="chart-container">
                <div id="mapa"></div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">馃挜 Eventos vs Afectados (Bubble)</h2>
            <div class="chart-container">
                <div class="chart-wrapper" style="height: 450px;"><canvas id="g5"></canvas></div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">馃彌锔?Municipios M谩s Cr铆ticos</h2>
            <div class="chart-container">
                <table>
                    <thead>
                        <tr><th>#</th><th>Municipio</th><th>Departamento</th><th>Afectados</th><th>Eventos</th></tr>
                    </thead>
                    <tbody id="tabla"></tbody>
                </table>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">馃搳 Estad铆sticas</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                <div style="background: var(--card-bg); padding: 1rem; border-radius: 8px; border-left: 3px solid var(--accent);">
                    <strong>Dpto Cr铆tico:</strong> <span id="depto-critico">-</span>
                </div>
                <div style="background: var(--card-bg); padding: 1rem; border-radius: 8px; border-left: 3px solid var(--accent);">
                    <strong>A帽o Cr铆tico:</strong> <span id="ano-critico">-</span>
                </div>
                <div style="background: var(--card-bg); padding: 1rem; border-radius: 8px; border-left: 3px solid var(--accent);">
                    <strong>Promedio:</strong> <span id="promedio">-</span>
                </div>
            </div>
        </section>
    </div>

    <footer>
        <p><strong>Fuente:</strong> Portal de Datos Abiertos Colombia | datos.gov.co</p>
        <p>UNAD | Maestr铆a en An谩lisis de Datos | Data Storytelling</p>
    </footer>

    <script>
        Chart.defaults.color = '#E8E8E8';
        Chart.defaults.borderColor = '#1F3A5F';

        const API_URL = 'https://www.datos.gov.co/resource/8rpn-wpty.json';
        let mapa;

        function fmt(n) {
            return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        async function descargarDatos() {
            console.log('鈴?Descargando datos...');
            let todos = [];
            let offset = 0;
            const limit = 50000;

            while (true) {
                try {
                    const url = `${API_URL}?$offset=${offset}&$limit=${limit}`;
                    const resp = await fetch(url);
                    const datos = await resp.json();
                    
                    if (!datos || datos.length === 0) break;
                    
                    todos = todos.concat(datos);
                    console.log(`鉁?${todos.length} registros...`);
                    offset += limit;
                } catch (e) {
                    console.error('Error:', e);
                    break;
                }
            }

            console.log(`鉁?Total: ${todos.length} registros`);
            return todos;
        }

        function procesarDatos(datos) {
            const stats = {
                totalAfectados: 0,
                totalEventos: datos.length,
                totalAsesinados: 0,
                totalHeridos: 0,
                anos: {},
                deptos: {},
                acciones: {},
                municipios: {}
            };

            datos.forEach(d => {
                const qty = parseInt(d.cantidad) || 0;
                stats.totalAfectados += qty;

                if (d.accion === 'ASESINADO') stats.totalAsesinados += qty;
                else stats.totalHeridos += qty;

                const ano = new Date(d.fecha_hecho).getFullYear();
                if (!stats.anos[ano]) stats.anos[ano] = { af: 0, as: 0, ev: 0 };
                stats.anos[ano].af += qty;
                stats.anos[ano].ev++;
                if (d.accion === 'ASESINADO') stats.anos[ano].as += qty;

                if (!stats.deptos[d.departamento]) stats.deptos[d.departamento] = { af: 0, as: 0, ev: 0, lat: 0, lon: 0 };
                stats.deptos[d.departamento].af += qty;
                stats.deptos[d.departamento].ev++;
                if (d.accion === 'ASESINADO') stats.deptos[d.departamento].as += qty;

                if (!stats.acciones[d.accion]) stats.acciones[d.accion] = 0;
                stats.acciones[d.accion] += qty;

                const key = `${d.municipio}|${d.departamento}`;
                if (!stats.municipios[key]) stats.municipios[key] = { mun: d.municipio, dep: d.departamento, af: 0, ev: 0 };
                stats.municipios[key].af += qty;
                stats.municipios[key].ev++;
            });

            return stats;
        }

        async function init() {
            try {
                const datos = await descargarDatos();
                const stats = procesarDatos(datos);

                document.getElementById('metric-afectados').textContent = fmt(stats.totalAfectados);
                document.getElementById('metric-eventos').textContent = fmt(stats.totalEventos);
                document.getElementById('metric-asesinados').textContent = fmt(stats.totalAsesinados);
                document.getElementById('metric-heridos').textContent = fmt(stats.totalHeridos);

                let maxD = { n: '-', a: 0 };
                Object.entries(stats.deptos).forEach(([d, s]) => {
                    if (s.af > maxD.a) maxD = { n: d, a: s.af };
                });
                document.getElementById('depto-critico').textContent = maxD.n;

                let maxA = { a: 2010, af: 0 };
                Object.entries(stats.anos).forEach(([a, s]) => {
                    if (s.af > maxA.af) maxA = { a: parseInt(a), af: s.af };
                });
                document.getElementById('ano-critico').textContent = maxA.a;

                const prom = stats.totalEventos > 0 ? (stats.totalAfectados / stats.totalEventos).toFixed(1) : 0;
                document.getElementById('promedio').textContent = prom + ' personas/evento';

                const anos = Object.keys(stats.anos).sort().map(a => ({
                    ano: parseInt(a),
                    af: stats.anos[a].af,
                    as: stats.anos[a].as,
                    ev: stats.anos[a].ev
                }));

                const deptos = Object.entries(stats.deptos).map(([d, s]) => ({
                    d, af: s.af, as: s.as, ev: s.ev, lat: coords[d]?.[0] || 0, lon: coords[d]?.[1] || 0
                })).sort((a, b) => b.af - a.af);

                const acciones = Object.entries(stats.acciones).map(([a, q]) => ({ a, q }));

                const munis = Object.values(stats.municipios).sort((a, b) => b.af - a.af).slice(0, 15);

                grafico1(anos);
                grafico2(acciones);
                grafico3(deptos);
                grafico4(deptos.slice(0, 8));
                grafico5(deptos);
                grafico6(munis);
                mapa_calor(deptos);

                console.log('鉁?Dashboard listo');
            } catch (e) {
                console.error('Error:', e);
                document.getElementById('metricas').innerHTML = '<p style="color: red; padding: 2rem;">Error: ' + e.message + '</p>';
            }
        }

        const coords = {
            'ANTIOQUIA': [6.2442, -75.5812], 'ARAUCA': [6.4953, -71.2165], 'ATLANTICO': [10.7941, -74.7850],
            'BOLIVAR': [9.0820, -74.4977], 'BOYACA': [5.5432, -72.7318], 'CALDAS': [5.1167, -75.5000],
            'CAQUETA': [1.6146, -72.2711], 'CAUCA': [2.3741, -76.6104], 'CESAR': [10.2193, -73.1233],
            'CHOCO': [5.6719, -76.6400], 'CORDOBA': [8.7577, -75.8811], 'CUNDINAMARCA': [5.0000, -74.3000],
            'GUAVIARE': [2.5700, -72.6406], 'HUILA': [2.9092, -75.2992], 'LA GUAJIRA': [11.3000, -72.9000],
            'MAGDALENA': [11.2381, -74.2192], 'META': [4.1433, -71.2807], 'NARI脩O': [1.2136, -77.2833],
            'NORTE DE SANTANDER': [7.3561, -72.1050], 'PUTUMAYO': [0.8021, -76.5320], 'QUINDIO': [4.5403, -75.4322],
            'RISARALDA': [5.3522, -75.7265], 'SANTANDER': [6.7744, -73.1198], 'SUCRE': [9.3046, -75.3969],
            'TOLIMA': [4.4086, -75.2324], 'VALLE DEL CAUCA': [4.5403, -76.0383], 'VAUPES': [1.0343, -70.1901],
            'VICHADA': [4.3333, -69.2667], 'BOGOTA D.C.': [4.7110, -74.0721]
        };

        function grafico1(anos) {
            new Chart(document.getElementById('g1'), {
                type: 'line',
                data: {
                    labels: anos.map(a => a.ano),
                    datasets: [
                        { label: 'Total', data: anos.map(a => a.af), borderColor: '#FFD700', backgroundColor: 'rgba(255,215,0,0.1)', borderWidth: 3, fill: true, tension: 0.4, pointRadius: 6, pointBackgroundColor: '#DC143C' },
                        { label: 'Asesinados', data: anos.map(a => a.as), borderColor: '#8B0000', borderWidth: 2, tension: 0.4 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: v => fmt(v) } } } }
            });
        }

        function grafico2(acc) {
            new Chart(document.getElementById('g2'), {
                type: 'doughnut',
                data: { labels: acc.map(a => a.a), datasets: [{ data: acc.map(a => a.q), backgroundColor: ['#8B0000', '#DC143C'], borderColor: '#0A0E27', borderWidth: 3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function grafico3(deptos) {
            const top = deptos.slice(0, 15);
            new Chart(document.getElementById('g3'), {
                type: 'bar',
                data: {
                    labels: top.map(d => d.d),
                    datasets: [{ label: 'Afectados', data: top.map(d => d.af), backgroundColor: top.map(d => `rgba(139,0,0,${0.5 + (d.af/Math.max(...top.map(x=>x.af)))*0.5})`), borderColor: '#FFD700', borderWidth: 2 }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { callback: v => fmt(v) } } } }
            });
        }

        function grafico4(deptos) {
            new Chart(document.getElementById('g4'), {
                type: 'radar',
                data: { labels: deptos.map(d => d.d), datasets: [{ label: 'Afectados', data: deptos.map(d => d.af), borderColor: '#FFD700', backgroundColor: 'rgba(255,215,0,0.1)', pointBackgroundColor: '#DC143C' }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function grafico5(deptos) {
            new Chart(document.getElementById('g5'), {
                type: 'bubble',
                data: { datasets: [{ label: 'Dpto', data: deptos.map(d => ({ x: d.ev, y: d.af, r: Math.sqrt(d.af/10) })), backgroundColor: 'rgba(220,20,60,0.5)', borderColor: '#FFD700', borderWidth: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { callback: v => fmt(v) } }, y: { ticks: { callback: v => fmt(v) } } } }
            });
        }

        function grafico6(munis) {
            const tbody = document.getElementById('tabla');
            tbody.innerHTML = munis.map((m, i) => `<tr><td style="color:var(--accent);font-weight:bold;">${i+1}</td><td><strong>${m.mun}</strong></td><td>${m.dep}</td><td style="color:var(--accent);font-weight:bold;">${fmt(m.af)}</td><td>${m.ev}</td></tr>`).join('');
        }

        function mapa_calor(deptos) {
            if (mapa) mapa.remove();
            mapa = L.map('mapa').setView([4.5, -74.3], 5);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '漏 OpenStreetMap', maxZoom: 19 }).addTo(mapa);

            const max = Math.max(...deptos.map(d => d.af));
            deptos.forEach(d => {
                if (d.lat && d.lon) {
                    const int = d.af / max;
                    let col = '#FFE4B5';
                    if (int >= 0.8) col = '#8B0000';
                    else if (int >= 0.6) col = '#DC143C';
                    else if (int >= 0.4) col = '#FF6347';
                    else if (int >= 0.2) col = '#FFA07A';

                    L.circleMarker([d.lat, d.lon], { radius: Math.min(Math.sqrt(d.af)/8, 40), fillColor: col, color: '#FFD700', weight: 2, fillOpacity: 0.7 })
                        .bindPopup(`<strong>${d.d}</strong><br/>Afectados: ${fmt(d.af)}`)
                        .addTo(mapa);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
